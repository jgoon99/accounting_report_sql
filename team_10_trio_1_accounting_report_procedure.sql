
/* ----------------------------------------------------------------------------------------------
	BASE TABLE LIST 
	1. P&L Statements Report Base Table
	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	
	2. B/S Report Base tables 
	- THIS YEAR 
	( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year ) AS THIS_YEAR
	- LAST YEAR
	( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year ) AS LAST_YEAR
   ---------------------------------------------------------------------------------------------- */

-- Stored procedure START
DELIMITER $$

-- EXISTING PROCEDURE CHECK AND DROP
DROP PROCEDURE IF EXISTS team_10_trio_1_account_report$$

-- CREATE PROCEDURE START 
CREATE PROCEDURE team_10_trio_1_account_report( IN fn_year INT) -- Input Valriable for Financial Year
BEGIN -- Begin 

	SET @last_year = fn_year - 1; -- Define Last year for Year over Year comparison.

	/* ********************************************************************************************************************************
	 *	Requirement Definition
	 * ----------------------------------------
	 * 1. Receive as an argument the year for which the user wants to produce the P&L and B/S statements.
	 * 2. Do the necessary calculations to obtain the net profit or loss for that year
	 * 3. Use that value, to produce the B/S
	 * 4. Demonstrate that A = L + E
	 * 5. Print both the P&L and B/S as clear as possible on the Result Grids
	 * 6. Show the % change vs. the previous year for every major line item on the P&L and B/S
	 * 7. Give some headings to each major account line item. And to each section of the P&L and B/S
	 * 8. Add any additional financial metrics and ratios that could be useful to analyze this start-up 
	 * 9. Produce a cash flow statement  as an added challenge
	 * 10. The stored procedure must have comprehensive comments explaining the purpose of each block of code
	 * -----------------------------------------
	 * 
	 * *********************************************************************************************************************************/

	/* -------------------------------------------------------------------------------------
		Build Report of P&L Statments
	   ------------------------------------------------------------------------------------- */
	-- 1. Title Of Report 
	SELECT	'P&L Statement' AS statement_section, '' AS THIS_YEAR, '' AS statement_section, '' AS LAST_YEAR, '' AS YoY_Growth
	 UNION	ALL
	-- 2. Financial Year Information
	SELECT	fn_year, '', @last_year, '', ''
	 UNION	ALL
	-- 3. Label of each Columns
	SELECT	'Statement Section', 'Amount', 'Statement Section', 'Amount', 'Growth (%)'
	 UNION	ALL
	-- Dividing Line
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	 UNION	ALL
	-- 4. Report lines of each statmens of This and Last Year.
	SELECT	IFNULL(THIS_YEAR_STATEMENT, '') -- If there is not same Statements it turn to blank field.
				,FORMAT( -- Number Formating
					IFNULL( -- Avoiding Null Values, convert to zero
						CASE -- If base table has not cost value it means revenue.
							WHEN THIS_YEAR_COST IS NULL 
								THEN THIS_YEAR_REVENUE 
							ELSE THIS_YEAR_COST 
						END, 0 -- NULL to 0
					), 2 -- Formating
				)
				,IFNULL(LAST_YEAR_STATEMENT, '')
				,FORMAT(
					IFNULL(
						CASE WHEN LAST_YEAR_COST IS NULL 
							THEN LAST_YEAR_REVENUE 
							ELSE LAST_YEAR_COST 
						END, 0
					), 2
				)
				,IFNULL( -- Calculate Year over Year Grouwh Rate
					ROUND(
						CASE 
							WHEN THIS_YEAR_COST IS NULL 
								THEN (THIS_YEAR_REVENUE / LAST_YEAR_REVENUE - 1) * 100.0
								ELSE (THIS_YEAR_COST / LAST_YEAR_COST - 1) * 100.0
						END, 2
					), 0
				)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 0
	 UNION	ALL
	-- 5. Total Revenue Rporting line
	SELECT	'Total Revenue'
				,FORMAT(SUM(IFNULL(THIS_YEAR_REVENUE, 0)), 2)
				,'Total Revenue'
				,FORMAT(SUM(IFNULL(LAST_YEAR_REVENUE, 0)),2)
				,IFNULL( -- Calculate Year over Year Grouth 
					ROUND(
						(SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
						/ SUM(IFNULL(LAST_YEAR_REVENUE, 0)) - 1) * 100.0, 2 -- Multiply 100.0 for convert to Percent and Round 2 digits
					), 0
				)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 0
	 UNION	ALL
	-- Dividing Line
	SELECT	'------------------', '-----------------', '-----------------', '-----------------', '-----------------'
	 UNION	ALL
	-- 6. Reporting COST OF GOODS AND SERVICES 
	 SELECT	IFNULL(THIS_YEAR_STATEMENT, '')
				,FORMAT(IFNULL(THIS_YEAR_COST, 0),2)
				,IFNULL(LAST_YEAR_STATEMENT, '')
				,FORMAT(IFNULL(LAST_YEAR_COST, 0),2)
				,IFNULL(ROUND((THIS_YEAR_COST / LAST_YEAR_COST - 1) * 100.0, 2), 0)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 1
	 			AND THIS_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES'
	 UNION	ALL
	 -- 7. Reporting Gross Profit Margin
	SELECT	'Gross Profit Margin'
				,format(
					(
						SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
						FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
						WHERE debit_is_positive = 0
					) - IFNULL(THIS_YEAR_COST, 0), 2)
				,'Gross Profit Margin'
				,format(
					(
						SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
						FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
						WHERE debit_is_positive = 0
					) - IFNULL(LAST_YEAR_COST, 0),2)
				,ROUND( -- Gross Profit Margin Year over Year Growth Calculate
					(
						(
							( -- This year
								SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0
							) - IFNULL(THIS_YEAR_COST, 0)
						)/ ( -- divede
							( -- Last YEar
								SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0
							) - IFNULL(LAST_YEAR_COST, 0)
						) - 1
					) * 100.0, 2
				)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES'
	 UNION ALL
	 -- 8. Gross Mrgin Percent by Revenue reporting
	 SELECT	'Gross Profit Margin %'
				,ROUND(
					(
						( -- GROSS MARGIN TOTAL Revenue - GOST OF GOODS AND SERVICES
							SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						) - IFNULL(THIS_YEAR_COST, 0) 
					) / ( -- DIVIDE TOTAL REVENUE
						(
							SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0)
						) * 100.0, 2
				)
				,'Gross Profit Margin %'
				,ROUND(
					(
						( -- GROSS MARGIN LAST YEAR = TOTAL REVENUE - COST OF GOODS AND SERVICES
							SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						) - IFNULL(LAST_YEAR_COST, 0)
					) / ( -- DIVIDE TOTAL REVENUE LAST YEAR
						( 
							SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						)
					) * 100.0, 2
				)
				,ROUND(
					( -- THIS YEAR GROSS MARGIN PROPORTION
						(
							(
								SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0
							) - IFNULL(THIS_YEAR_COST, 0)
						) / (
							(
								SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0
							)
						) * 100.0
					) - ( -- LAST YEAR GROSS MARGIN PROPORTION SUB
							(
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(LAST_YEAR_COST, 0)
							) / (
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								)
							) * 100.0
					), 2)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES'
	 UNION ALL
	-- DIVIDE LINE
	SELECT	'-------------------', '-----------------', '-----------------', '-----------------', '-----------------'
	 UNION ALL
	-- 9. EXPENSES  Reporting Line
	SELECT	IFNULL(THIS_YEAR_STATEMENT, '')
				,FORMAT(IFNULL(THIS_YEAR_COST, 0),2)
				,IFNULL(LAST_YEAR_STATEMENT, '')
				,FORMAT(IFNULL(LAST_YEAR_COST, 0),2)
				,IFNULL(ROUND((THIS_YEAR_COST / LAST_YEAR_COST - 1) * 100.0, 2), 0)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 1
	 			AND THIS_YEAR_STATEMENT NOT IN ('INCOME TAX', 'COST OF GOODS AND SERVICES')
	 UNION	ALL
	-- 10. OTHER EXPENSES Reporting Line
	SELECT	'OEXP'
				,FORMAT(SUM(IFNULL(THIS_YEAR_COST, 0)),2)
				,'OEXP'
				,FORMAT(SUM(IFNULL(LAST_YEAR_COST, 0)),2)
				,IFNULL(ROUND((SUM(IFNULL(THIS_YEAR_COST, 0)) / SUM(IFNULL(LAST_YEAR_COST, 0)) - 1 ) * 100.0, 2), 0)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 1
	 			AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
	 UNION	ALL
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	 UNION ALL
	-- 11. EBITDA Margin Reporting Line 
	SELECT	'EBITDA Margin' -- EBITDA MARGIN THIS YEAR
				,format(
					( -- Gross Margin - OEXP = EBITDA
						( -- (TOTAL REVENUE - COST OF GOODS AND SERVICES)
							SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						) - IFNULL(THIS_YEAR_COST, 0)
					) - ( -- - OEXP
							SELECT SUM(IFNULL(THIS_YEAR_COST, 0))
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
					), 2
				)
				,'EBITDA Margin' -- EBITDA Margin LAST YEAR
				,format(
					(
						( -- (TOTAL REVENUE - COST OF GOODS AND SERVICES)
							SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						) - IFNULL(LAST_YEAR_COST, 0)
					) - ( -- (TOTAL REVENUE - COST OF GOODS AND SERVICES) - OTHER EXPENSES
							SELECT SUM(IFNULL(LAST_YEAR_COST, 0))
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
					), 2)
				,ROUND( -- EBITDA YOY GROWTH RATE 
					( -- EBITDA THIS YEAR / EBITDA LAST YEAR - 1
						(
							( -- EBITDA THIS YEAR 
								( -- (TOTAL REVENUE - COST OF GOODS AND SERVICES)
									SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(THIS_YEAR_COST, 0)
							) - ( -- (TOTAL REVENUE - COST OF GOODS AND SERVICES) - OTHER EXPENSES
									SELECT SUM(IFNULL(THIS_YEAR_COST, 0))
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) / ( -- EBITDA LAST YEAR 
							(
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(LAST_YEAR_COST, 0)
							) - (
									SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) - 1
					) * 100.0, 2
				)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES'
	 UNION ALL
	-- 12. EBITDA Proportion Report line
	SELECT	'EBITDA %' -- EBITDA THIS YEAR 
				,ROUND(
					(
						(
							(
								(
									SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(THIS_YEAR_COST, 0)
							) - (
									SELECT SUM(IFNULL(THIS_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL 
									WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) / (
							(
								SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0)
						)
					) * 100.0, 2
				)
				,'EBITDA %'
				,ROUND(
					(
						(
							(
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(LAST_YEAR_COST, 0)
							) - (
									SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) / (
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0)
						)
					) * 100.0, 2
				)
				,ROUND(
					(
						(
							(
								(
									(
										SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
										FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
										WHERE debit_is_positive = 0
									) - IFNULL(THIS_YEAR_COST, 0)
								) - (
										SELECT SUM(IFNULL(THIS_YEAR_COST, 0)) 
										FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
										WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
								)
							) / (
								(
									SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0)
							)
						) * 100.0
					) - (
						(
							(
								(
									(
										SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
										FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
										WHERE debit_is_positive = 0
									) - IFNULL(LAST_YEAR_COST, 0)
								) - (
										SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
										FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
										WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
								)
							) / (
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0)
							)
						) * 100.0
					), 2
				)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES'
	 UNION ALL
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	 UNION ALL
	-- 13. Depreciation & Ammortization Report line: but This data is not available. So Only 0.
	SELECT	'Depreciation & Ammortization', 0, 'Depreciation & Ammortization', 0, ''
	 UNION ALL
	-- 14. EBIT REPORTING LINE
	SELECT	'EBIT'
				,format(
					(
						(
							SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						) - IFNULL(THIS_YEAR_COST, 0)
					) - (
							SELECT SUM(IFNULL(THIS_YEAR_COST, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
					), 2
				)
				,'EBIT'
				,format(
					(
						(
							SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 0
						) - IFNULL(LAST_YEAR_COST, 0)
					) - (
							SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
							FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
							WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
					), 2
				)
				,ROUND(
					(
						(
							(
								(
									SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(THIS_YEAR_COST, 0)
							) - (
									SELECT SUM(IFNULL(THIS_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) / (
							(
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - IFNULL(LAST_YEAR_COST, 0)
							) - (
									SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) - 1
					) * 100.0, 2
				)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES'
	 UNION ALL
	-- 15. INCOME TAX Reporting Line
	SELECT	'Income Tax'
				,FORMAT(IFNULL(THIS_YEAR_COST, 0),2)
				,'Income Tax'
				,FORMAT(IFNULL(LAST_YEAR_COST, 0),2)
				,IFNULL(
					ROUND((THIS_YEAR_COST / LAST_YEAR_COST - 1) * 100.0, 2), 0)
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 1
	 			AND (THIS_YEAR_STATEMENT = 'INCOME TAX' OR LAST_YEAR_STATEMENT = 'INCOME TAX')
	 UNION	ALL
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	 UNION ALL
	-- 16. Net Income Reporting Line
	SELECT	'Net Income'
				,format(
					(
						(
							(
								SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0
							) - ( 
								SELECT IFNULL(THIS_YEAR_COST, 0) 
								FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES')
						) - (
								SELECT SUM(IFNULL(THIS_YEAR_COST, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
						)
					) - (IFNULL(THIS_YEAR_COST, 0)),2
				)
				,'Net Income'
				,format(
					(
						(
							(
								SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 0
							) - ( 
								SELECT IFNULL(LAST_YEAR_COST, 0) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES') 
						) - (
								SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
								FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
								WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
						)
					) - (IFNULL(LAST_YEAR_COST, 0)),2
				)
				,ROUND(
					(((
						(
							(
								(
									SELECT SUM(IFNULL(THIS_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - ( 
									SELECT IFNULL(THIS_YEAR_COST, 0) 
									FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES')
							) - (
									SELECT SUM(IFNULL(THIS_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND THIS_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) - (IFNULL(THIS_YEAR_COST, 0))
					)-(
						(
							(
								(
									SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 0
								) - ( 
									SELECT IFNULL(LAST_YEAR_COST, 0) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES') 
							) - (
									SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
									FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
									WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
							)
						) - (IFNULL(LAST_YEAR_COST, 0))
					))/(
						ABS(
								(
									(
										(
											SELECT SUM(IFNULL(LAST_YEAR_REVENUE, 0)) 
											FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
											WHERE debit_is_positive = 0
										) - ( 
											SELECT IFNULL(LAST_YEAR_COST, 0) 
											FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
											WHERE LAST_YEAR_STATEMENT = 'COST OF GOODS AND SERVICES') 
									) - (
											SELECT SUM(IFNULL(LAST_YEAR_COST, 0)) 
											FROM (SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
											WHERE debit_is_positive = 1 AND LAST_YEAR_STATEMENT IN ('SELLING EXPENSES','OTHER EXPENSES')
									)
								) - (IFNULL(LAST_YEAR_COST, 0))
						)
					))*100.0, 2
				)	
	  FROM	(SELECT THIS_YEAR.statement_section AS THIS_YEAR_STATEMENT ,THIS_YEAR.COST_AMOUNT AS THIS_YEAR_COST ,THIS_YEAR.REVENUE_AMOUNT AS THIS_YEAR_REVENUE ,LAST_YEAR.statement_section AS LAST_YEAR_STATEMENT ,LAST_YEAR.COST_AMOUNT AS LAST_YEAR_COST ,LAST_YEAR.REVENUE_AMOUNT AS LAST_YEAR_REVENUE ,debit_is_positive FROM ( SELECT DISTINCT c.statement_section ,debit_is_positive FROM journal_entry_line_item AS a LEFT JOIN account AS b ON a.account_id = b.account_id LEFT JOIN statement_section AS c ON b.profit_loss_section_id = c.statement_section_id LEFT JOIN journal_entry AS j ON a.journal_entry_id = j.journal_entry_id WHERE c.is_balance_sheet_section = 0 AND c.statement_section != '' AND j.cancelled = 0 AND b.visible_for_posting = 1 ORDER BY debit_is_positive ASC ) AS statement_tbl LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN `account` INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS THIS_YEAR ON statement_tbl.statement_section = THIS_YEAR.statement_section LEFT JOIN ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF ,CASE WHEN s.statement_section != '' THEN s.statement_section ELSE s2.statement_section END AS statement_section ,SUM( CASE WHEN s.statement_section IN ('COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX') THEN IFNULL(debit, 0) - IFNULL(credit, 0) END ) AS COST_AMOUNT ,SUM( CASE WHEN s.statement_section IN ('OTHER INCOME', 'REVENUE') THEN IFNULL(credit, 0) - IFNULL(debit, 0) END ) AS REVENUE_AMOUNT FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year GROUP BY DATE_FORMAT(entry_date, '%Y') ,statement_section ORDER BY YEAR_OF, statement_section ) AS LAST_YEAR ON statement_tbl.statement_section = LAST_YEAR.statement_section) AS BASE_FOR_PNL
	 WHERE	debit_is_positive = 1
	 			AND (THIS_YEAR_STATEMENT = 'INCOME TAX' OR LAST_YEAR_STATEMENT = 'INCOME TAX')
	 UNION ALL
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	;
	
	/* -------------------------------------------------------------------------------------
	  	Build Report of Balance Sheet
   ------------------------------------------------------------------------------------- */
	-- 1. REPORT TITLE LINE
	SELECT	'Balance Sheet' AS Jounal_Entry, '' AS Line_item, '' AS `Description`, '' AS `Acccount`, '' AS Assets, '' AS Liabilities, '' AS Equity, '' AS BALANCE
	UNION ALL
	-- 2. REPORT FINALNCIAL YEAR
	SELECT	fn_year, '','','','','','',''
	UNION ALL 
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	UNION ALL 
	/*
	 3. REPORT LABEL 
		Journal Entry - Transaction title 
		Number - Sequence number of each transaction
		Description - Detail Information of each Transaction
		Account - Account Information of each Transaction
		Assets - B/S Assets Include Current Assets, Fixed Assets Statements
		Liabilities - B/S Liabilities Statements include CURRENT LIABILITIES
		Equity - B/S and P&L Statements include COST OF GOODS AND SERVICES, REVENUE, EQUITY, SELLING EXPENSES, OTHER EXPENSES, OTHER INCOME, INCOME TAX
		BALANCE - Assets - (Liabilities + Equity) 
	*/
	SELECT	'Journal Entry', 'Number', 'Decription', 'Account', 'Assets', 'Liabilities', 'Equity', 'BALANCE'
	UNION ALL 
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	UNION ALL 
	-- 4. ENTIRE TRANSACTION BALANCE STATUS
	SELECT	journal_entry
				,line_item
				,DESCRIPTION
				,ACCOUNT
				,FORMAT(ASSETS, 2)
				,FORMAT(LIABILITIES, 2)
				,FORMAT(EQUITY, 2)
				,''-- SUM(ASSETS - (LIABILITIES + EQUITY)) OVER(PARTITION BY journal_entry) 
				-- BASE TABLE FOR THIS YEAR B/S
	  FROM	( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year ) AS THIS_YEAR
	UNION ALL
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	UNION ALL
	-- 5. FINANCIAL YEAR TOTAL REPORT LINE
	SELECT	CONCAT('TOTAL (', fn_year, ')')
				,''
				,'BALANCE OF YEAR: ASSETS - (LIABILITIES - EQUITY)'
				,''
				,FORMAT(SUM(ASSETS), 2) AS ASSETS
				,FORMAT(SUM(LIABILITIES), 2) AS LIABILITIES
				,FORMAT(SUM(EQUITY), 2) AS EQUITY
				,FORMAT(SUM(ASSETS) - (SUM(LIABILITIES) + SUM(EQUITY)), 2) 
	  FROM	( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year ) AS THIS_YEAR
	UNION ALL
	-- 6. FINANCIAL LAST YEAR TOTAL REPORT LINE
	SELECT	CONCAT('LAST YEAR TOTAL (', @last_year, ')')
				,''
				,'BALANCE OF LAST YEAR: ASSETS - (LIABILITIES - EQUITY)'
				,''
				,FORMAT(SUM(ASSETS), 2) AS ASSETS
				,FORMAT(SUM(LIABILITIES), 2) AS LIABILITIES
				,FORMAT(SUM(EQUITY), 2) AS EQUITY
				,FORMAT(SUM(ASSETS) - (SUM(LIABILITIES) + SUM(EQUITY)), 2) 
	  FROM	( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year ) AS LAST_YEAR
	UNION ALL
	-- 7. YEAR OF YEAR GROWTH REPORT LINE
	SELECT	'YoY Growth'
				,''
				,''
				,''
				,ROUND(
					(
						(
							SELECT SUM(ASSETS) 
							FROM ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year ) AS THIS_YEAR
						) / (
							SELECT SUM(ASSETS) 
							FROM ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year ) AS LAST_YEAR
						) - 1
					) * 100.0, 2
				)
				,ROUND(
					(
						(
							SELECT SUM(LIABILITIES) 
							FROM ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year ) AS THIS_YEAR
						) / (
							SELECT SUM(LIABILITIES) 
							FROM ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year ) AS LAST_YEAR
						) - 1
					) * 100.0, 2
				)
				,ROUND(
					(
						(
							SELECT SUM(EQUITY) 
							FROM ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = fn_year ) AS THIS_YEAR
						) / (
							SELECT SUM(EQUITY) 
							FROM ( SELECT DATE_FORMAT(entry_date, '%Y') AS YEAR_OF, entry_date, journal_entry, line_item, account, description, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND credit IS NULL THEN IFNULL(debit, 0) WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT ASSETS','FIXED ASSETS') AND debit IS NULL THEN IFNULL(credit, 0) * -1 ELSE 0 END, 2 ) AS ASSETS, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ('CURRENT LIABILITIES') AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS LIABILITIES, ROUND( CASE WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND credit IS NULL THEN IFNULL(debit, 0) * -1 WHEN IF( s.statement_section = '', s2.statement_section, s.statement_section ) IN ( 'REVENUE', 'OTHER INCOME', 'COST OF GOODS AND SERVICES', 'OTHER EXPENSES', 'SELLING EXPENSES', 'INCOME TAX', 'EQUITY' ) AND debit IS NULL THEN IFNULL(credit, 0) ELSE 0 END, 2 ) AS EQUITY FROM journal_entry_line_item AS BASE NATURAL JOIN account INNER JOIN journal_entry AS J ON BASE.journal_entry_id = J.journal_entry_id INNER JOIN statement_section AS s ON account.profit_loss_section_id = s.statement_section_id INNER JOIN statement_section AS s2 ON account.balance_sheet_section_id = s2.statement_section_id WHERE visible_for_posting = 1 AND debit_credit_balanced = 1 AND cancelled = 0 AND closing_type = 0 AND DATE_FORMAT(entry_date, '%Y') = @last_year ) AS LAST_YEAR
						) - 1
					) * 100.0, 2
				)
				,''
	UNION ALL
	-- LINE BREAK
	SELECT	'-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------', '-----------------'
	;
END$$
DELIMITER ;

/* *****************************************
	 
	 PROCEDURE: ychoung_team_10_account_report
	 INPUT:
		1. fn_year INT: Financial Year for Report INPUT RANGE (2014 ~ 2020)
	 OUTPUT:
		TABLE 1. P&L Statements Report Financial YEAR and Last YEAR with YoY Growth Rate
		TABLE 2. B/S Report of Financial YEAR and Total of LAST YEAR with YoY Grouwth Rate
		
 * ***************************************** */
CALL team_10_trio_1_account_report(2015);
